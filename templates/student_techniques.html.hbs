{{#*inline "content"}}
<h2>{{ student.username }}'s Techniques</h2>
{{#if student_techniques}}
    <div class="techniques-container">
        {{#each student_techniques}}
            <div class="technique-card {{ this.status }}">
                <div class="technique-header"
                     onclick="toggleTechniqueDetails('{{ this.id }}', event)">
                    <h3>{{ this.technique_name }}</h3>
                    <button class="btn edit-btn" onclick="showEditForm('{{ this.id }}', event)">Edit</button>
                </div>
                <div id="technique-details-{{ this.id }}"
                     class="technique-details"
                     style="display: none">
                    <div class="technique-section">
                        <h4>Description</h4>
                        <p>{{ this.technique_description }}</p>
                    </div>
                    <div class="technique-section">
                        <h4>Student Notes</h4>
                        <p>{{ this.student_notes }}</p>
                    </div>
                    <div class="technique-section">
                        <h4>Coach Notes</h4>
                        <p>{{ this.coach_notes }}</p>
                    </div>
                </div>
                <!-- Edit Form (Hidden by default) -->
                <div id="edit-form-{{ this.id }}" class="edit-form" style="display: none;">
                    <form action="/student_technique/{{ this.id }}" method="post">
                        <div class="form-group">
                            <label for="status-{{ this.id }}">Status:</label>
                            <select name="status" id="status-{{ this.id }}" class="status-select">
                                <option value="red"
                                        label="Not Yet Started"
                                        {{#if (eq this.status "red")}}
                                        selected
                                        {{/if}}>Red
                                </option>
                                <option value="amber"
                                        label="In Progress"
                                        {{#if (eq this.status "amber")}}
                                        selected
                                        {{/if}}>Amber
                                </option>
                                <option value="green"
                                        label="Completed"
                                        {{#if (eq this.status "green")}}
                                        selected
                                        {{/if}}>Green
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-notes-view-{{ this.id }}">Student Notes (Read-only):</label>
                            <div class="read-only-text">{{ this.student_notes }}</div>
                            <!-- Hidden field to preserve student notes when coach submits the form -->
                            <input type="hidden" name="student_notes" value="{{ this.student_notes }}">
                        </div>
                        <div class="form-group">
                            <label for="coach-notes-{{ this.id }}">Coach Notes:</label>
                            <textarea name="coach_notes" id="coach-notes-{{this.id}}">{{this.coach_notes}}</textarea>
                        </div>
                        <div class="form-group">
                            <div class="warning-container"
                                 id="name-warning-{{ this.id }}"
                                 style="display: none">
                                <div class="warning-message">
                                    <strong>Warning:</strong> This will update the technique name globally for all students.
                                </div>
                            </div>
                            <label for="technique-name-{{ this.id }}">Technique Name:</label>
                            <input type="text"
                                   name="technique_name"
                                   id="technique-name-{{ this.id }}"
                                   value="{{ this.technique_name }}"
                                   data-original="{{ this.technique_name }}"
                                   oninput="checkForChanges('name', '{{ this.id }}')">
                        </div>
                        <div class="form-group">
                            <div class="warning-container"
                                 id="description-warning-{{ this.id }}"
                                 style="display: none">
                                <div class="warning-message">
                                    <strong>Warning:</strong> This will update the technique description globally for all students.
                                </div>
                            </div>
                            <label for="technique-description-{{ this.id }}">Technique Description:</label>
                            <textarea name="technique_description"
                                      id="technique-description-{{ this.id }}"
                                      data-original="{{ this.technique_description }}"
                                      oninput="checkForChanges('description', '{{ this.id }}')">{{ this.technique_description }}</textarea>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn save-btn">Save Changes</button>
                            <button type="button"
                                    class="btn cancel-btn"
                                    onclick="hideEditForm('{{ this.id }}')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        {{/each}}
    </div>
{{ else }}
    <p>No techniques assigned to this student yet.</p>
{{/if}}
<div class="add-form">
    <h3>Add Techniques to Student</h3>

    <!-- Bulk Add Section -->
    <form action="/student/{{ student.id }}/add_techniques" method="post">
        <div class="form-group">
            <h4>Select Existing Techniques</h4>
            {{#if unassigned_techniques}}
                <div class="technique-checkbox-grid">
                    {{#each unassigned_techniques}}
                        <div class="technique-checkbox">
                            <input type="checkbox" id="tech-{{this.id}}" name="technique_ids" value="{{this.id}}">
                            <label for="tech-{{this.id}}">{{this.name}}</label>
                        </div>
                    {{/each}}
                </div>
                <button type="submit" class="btn add-btn">Add Selected Techniques</button>
            {{else}}
                <p>All techniques have been assigned to this student.</p>
            {{/if}}
        </div>
    </form>

    <!-- Create New Technique Toggle -->
    <button class="btn toggle-btn" onclick="toggleCreateForm()">Create New Technique</button>
    
    <!-- Create New Technique Form (Hidden by default) -->
    <div id="create-technique-form" style="display: none;">
        <h4>Create New Technique</h4>
        <form action="/student/{{ student.id }}/create_technique" method="post">
            <div class="form-group">
                <label for="new-technique-name">Technique Name:</label>
                <input type="text" id="new-technique-name" name="name" required>
            </div>
            <div class="form-group">
                <label for="new-technique-description">Description:</label>
                <textarea id="new-technique-description" name="description" required></textarea>
            </div>
            <button type="submit" class="btn create-btn">Create & Add to Student</button>
            <button type="cancel" class="btn cancel-btn" onclick="toggleCreateForm()">Cancel</button>
        </form>
    </div>
</div>
<script>
    function toggleTechniqueDetails(id, event) {
        // Prevent the click from triggering for child elements
        if (event.target.closest('.edit-btn')) {
            return;
        }
        
        const detailsElement = document.getElementById('technique-details-' + id);
        const editFormElement = document.getElementById('edit-form-' + id);

        if (editFormElement.style.display === 'block') {
           return;
        }
        
        if (detailsElement.style.display === 'none') {
            detailsElement.style.display = 'block';
        } else {
            detailsElement.style.display = 'none';
        }
    }
    
    function showEditForm(id, event) {
        // Stop the click from bubbling up to the header
        if (event) {
            event.stopPropagation();
        }
        
        document.getElementById('technique-details-' + id).style.display = 'none';
        document.getElementById('edit-form-' + id).style.display = 'block';
    }
    
    function hideEditForm(id) {
        document.getElementById('edit-form-' + id).style.display = 'none';
        document.getElementById('technique-details-' + id).style.display = 'none';
        
        // Reset warning visibility
        document.getElementById('name-warning-' + id).style.display = 'none';
        document.getElementById('description-warning-' + id).style.display = 'none';
    }
    
    function checkForChanges(fieldType, id) {
        const field = document.getElementById(`technique-${fieldType}-${id}`);
        const originalValue = field.getAttribute('data-original');
        const currentValue = field.value;
        const warningElement = document.getElementById(`${fieldType}-warning-${id}`);
        
        if (currentValue !== originalValue) {
            // Show warning if value has changed
            warningElement.style.display = 'block';
        } else {
            // Hide warning if value is back to original
            warningElement.style.display = 'none';
        }
    }

    function toggleCreateForm() {
        const form = document.getElementById('create-technique-form');
        if (form.style.display === 'none') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }
</script>
{{/inline}}
{{> layout}}
