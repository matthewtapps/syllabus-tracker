{{#*inline "content"}}
<h2>{{ student.username }}'s Techniques</h2>
{{#if student_techniques}}
    <div class="techniques-container">
        {{#each student_techniques}}
            <div class="technique-card {{ this.status }}">
                <div class="technique-header"
                     onclick="toggleTechniqueDetails('{{ this.id }}', event)">
                    <h3>{{ this.technique_name }}</h3>
                    <button class="btn edit-btn" onclick="showEditForm('{{ this.id }}', event)">Edit</button>
                </div>
                <div id="technique-details-{{ this.id }}"
                     class="technique-details"
                     style="display: none">
                    <div class="technique-section">
                        <h4>Description</h4>
                        <p>{{ this.technique_description }}</p>
                    </div>
                    <div class="technique-section">
                        <h4>Student Notes</h4>
                        <p>{{ this.student_notes }}</p>
                    </div>
                    <div class="technique-section">
                        <h4>Coach Notes</h4>
                        <p>{{ this.coach_notes }}</p>
                    </div>
                </div>
                <!-- Edit Form (Hidden by default) -->
                <div id="edit-form-{{ this.id }}" class="edit-form" style="display: none;">
                    <form action="/student_technique/{{ this.id }}" method="post">
                        <div class="form-group">
                            <label for="status-{{ this.id }}">Status:</label>
                            <select name="status" id="status-{{ this.id }}" class="status-select">
                                <option value="red"
                                        label="Not Yet Started"
                                        {{#if (eq this.status "red")}}
                                        selected
                                        {{/if}}>Red
                                </option>
                                <option value="amber"
                                        label="In Progress"
                                        {{#if (eq this.status "amber")}}
                                        selected
                                        {{/if}}>Amber
                                </option>
                                <option value="green"
                                        label="Completed"
                                        {{#if (eq this.status "green")}}
                                        selected
                                        {{/if}}>Green
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="coach-notes-{{ this.id }}">Coach Notes:</label>
                            <textarea name="coach_notes" id="coach-notes-{{this.id}}">{{this.coach_notes}}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="student-notes-view-{{ this.id }}">Student Notes (Read-only):</label>
                            <div class="read-only-text">{{ this.student_notes }}</div>
                            <!-- Hidden field to preserve student notes when coach submits the form -->
                            <input type="hidden" name="student_notes" value="{{ this.student_notes }}">
                        </div>
                        <div class="form-group">
                            <div class="warning-container"
                                 id="name-warning-{{ this.id }}"
                                 style="display: none">
                                <div class="warning-message">
                                    <strong>Warning:</strong> This will update the technique name globally for all students.
                                </div>
                            </div>
                            <label for="technique-name-{{ this.id }}">Technique Name:</label>
                            <input type="text"
                                   name="technique_name"
                                   id="technique-name-{{ this.id }}"
                                   value="{{ this.technique_name }}"
                                   data-original="{{ this.technique_name }}"
                                   oninput="checkForChanges('name', '{{ this.id }}')">
                        </div>
                        <div class="form-group">
                            <div class="warning-container"
                                 id="description-warning-{{ this.id }}"
                                 style="display: none">
                                <div class="warning-message">
                                    <strong>Warning:</strong> This will update the technique description globally for all students.
                                </div>
                            </div>
                            <label for="technique-description-{{ this.id }}">Technique Description:</label>
                            <textarea name="technique_description"
                                      id="technique-description-{{ this.id }}"
                                      data-original="{{ this.technique_description }}"
                                      oninput="checkForChanges('description', '{{ this.id }}')">{{ this.technique_description }}</textarea>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn save-btn">Save Changes</button>
                            <button type="button"
                                    class="btn cancel-btn"
                                    onclick="hideEditForm('{{ this.id }}')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        {{/each}}
    </div>
{{ else }}
    <p>No techniques assigned to this student yet.</p>
{{/if}}
<!-- Add Technique Form -->
<div class="add-form">
    <h3>Add Technique to Student</h3>
    <form action="/student/{{ student.id }}/add_technique" method="post">
        <div class="form-group">
            <label for="technique">Select Technique:</label>
            <select name="technique_id" id="technique" required>
                <option value="">-- Select a Technique --</option>
                {{#each all_techniques}}
                    <option value="{{ this.id }}">{{ this.name }}</option>
                {{/each}}
            </select>
        </div>
        <button type="submit" class="btn add-btn">Add Technique</button>
    </form>
</div>
<style>
    .techniques-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-bottom: 20px;
    }
    
    .technique-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .technique-card.red {
        border-left: 5px solid #dc3545;
    }
    
    .technique-card.amber {
        border-left: 5px solid #ffc107;
    }
    
    .technique-card.green {
        border-left: 5px solid #28a745;
    }
    
    .technique-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        cursor: pointer;
    }
    
    .technique-header:hover {
        background-color: #e9ecef;
    }
    
    .technique-header h3 {
        margin: 0;
    }
    
    .technique-details {
        padding: 16px;
        border-top: 1px solid #eee;
    }
    
    .technique-section {
        margin-bottom: 16px;
    }
    
    .technique-section:last-child {
        margin-bottom: 0;
    }
    
    .edit-btn {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
    }
    
    .edit-btn:hover {
        background-color: #0069d9;
    }
    
    .edit-form {
        padding: 16px;
        border-top: 1px solid #eee;
        background-color: #f9f9f9;
    }

    .warning-container {
        margin-bottom: 8px;
    }
    
    .warning-message {
        padding: 8px 12px;
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        color: #856404;
        border-radius: 4px;
        font-size: 14px;
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .read-only-text {
        padding: 8px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 60px;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .form-group textarea {
        min-height: 80px;
    }
    
    .form-buttons {
        display: flex;
        gap: 10px;
    }
    
    .save-btn {
        padding: 8px 16px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .save-btn:hover {
        background-color: #218838;
    }
    
    .cancel-btn {
        padding: 8px 16px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .cancel-btn:hover {
        background-color: #5a6268;
    }
</style>
<script>
    function toggleTechniqueDetails(id, event) {
        // Prevent the click from triggering for child elements
        if (event.target.closest('.edit-btn')) {
            return;
        }
        
        const detailsElement = document.getElementById('technique-details-' + id);
        const editFormElement = document.getElementById('edit-form-' + id);

        if (editFormElement.style.display === 'block') {
           return;
        }
        
        if (detailsElement.style.display === 'none') {
            detailsElement.style.display = 'block';
        } else {
            detailsElement.style.display = 'none';
        }
    }
    
    function showEditForm(id, event) {
        // Stop the click from bubbling up to the header
        if (event) {
            event.stopPropagation();
        }
        
        document.getElementById('technique-details-' + id).style.display = 'none';
        document.getElementById('edit-form-' + id).style.display = 'block';
    }
    
    function hideEditForm(id) {
        document.getElementById('edit-form-' + id).style.display = 'none';
        document.getElementById('technique-details-' + id).style.display = 'none';
        
        // Reset warning visibility
        document.getElementById('name-warning-' + id).style.display = 'none';
        document.getElementById('description-warning-' + id).style.display = 'none';
    }
    
    function checkForChanges(fieldType, id) {
        const field = document.getElementById(`technique-${fieldType}-${id}`);
        const originalValue = field.getAttribute('data-original');
        const currentValue = field.value;
        const warningElement = document.getElementById(`${fieldType}-warning-${id}`);
        
        if (currentValue !== originalValue) {
            // Show warning if value has changed
            warningElement.style.display = 'block';
        } else {
            // Hide warning if value is back to original
            warningElement.style.display = 'none';
        }
    }
</script>
{{/inline}}
{{> layout}}
