name: Build and Deploy to Production
on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  BUILDEVENT_FILE: "/tmp/buildevent-attrs"

jobs:
  start-build-and-test-span:
    runs-on: ubuntu-latest
    outputs:
      trace_id: ${{ steps.start_trace.outputs.trace_id }}
      build_span_id: ${{ steps.start_build_span.outputs.span_id }}
      build_span_start: ${{ steps.start_build_span.outputs.start_time }}

    steps:
      - uses: honeycombio/gha-buildevents@v2
        with:
          apikey: ${{ secrets.HONEYCOMB_API_KEY }}
          dataset: syllabus-tracker-build-events

      - name: Start trace
        id: start_trace
        run: |
          echo "trace_id=$TRACE_ID" >> $GITHUB_OUTPUT

      - name: Start build parent span
        id: start_build_span
        run: |
          START_TIME=$(date +%s)
          SPAN_ID="build-and-test-span"

          echo "span_id=$SPAN_ID" >> $GITHUB_OUTPUT
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT

          buildevents span $TRACE_ID $SPAN_ID $START_TIME "Build and Test" &

  test:
    runs-on: ubuntu-latest
    needs: [start-build-and-test-span]

    steps:
      - uses: honeycombio/gha-buildevents@v2
        with:
          apikey: ${{ secrets.HONEYCOMB_API_KEY }}
          dataset: syllabus-tracker-build-events

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Set test start time
        id: test-start
        run: |
          echo "STEP_START=$(date +%s)" >> $GITHUB_OUTPUT
          echo "STEP_ID=run_tests" >> $GITHUB_OUTPUT
          echo "TRACE_PARENT=${{ needs.start-build-and-test-span.outputs.build_span_id }}" >> $GITHUB_OUTPUT

      - name: Run cargo fmt check
        run: |
          cargo fmt --all -- --check
          echo " fmt_passed=true" >> $BUILDEVENT_FILE

      - name: Run cargo clippy
        run: |
          cargo clippy -- -D warnings
          echo " clippy_passed=true" >> $BUILDEVENT_FILE
        env:
          SQLX_OFFLINE: "true"

      - name: Run Rust tests
        run: |
          cargo test --all
          echo " tests_passed=true" >> $BUILDEVENT_FILE
        env:
          SQLX_OFFLINE: "true"

      - name: Log test results to telemetry
        run: |
          STEP_ID=$(echo "${{ steps.test-start.outputs.STEP_ID }}")
          STEP_START=$(echo "${{ steps.test-start.outputs.STEP_START }}")
          PARENT_ID=$(echo "${{ steps.test-start.outputs.TRACE_PARENT }}")
          buildevents child $TRACE_ID $PARENT_ID $STEP_ID $STEP_START "Run Tests"

  build-backend:
    runs-on: ubuntu-latest
    needs: [start-build-and-test-span]
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.get_short_sha.outputs.short_sha }}

    steps:
      - uses: honeycombio/gha-buildevents@v2
        with:
          apikey: ${{ secrets.HONEYCOMB_API_KEY }}
          dataset: syllabus-tracker-build-events

      - name: Set build start timestamp
        id: build-backend-image
        run: |
          echo "STEP_START=$(date +%s)" >> $GITHUB_OUTPUT
          echo "STEP_ID=build-backend-image" >> $GITHUB_OUTPUT
          echo "TRACE_PARENT=${{ needs.start-build-and-test-span.outputs.build_span_id }}" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get short SHA
        id: get_short_sha
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push backend Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/app:${{ steps.get_short_sha.outputs.short_sha }},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/app:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            HONEYCOMB_API_KEY=${{ secrets.HONEYCOMB_API_KEY }}
            ROCKET_SECRET_KEY=${{ secrets.ROCKET_SECRET_KEY }}

      - name: Log build details to telemetry
        run: |
          echo " backend_image_tag=app:${{ steps.get_short_sha.outputs.short_sha }}" >> $BUILDEVENT_FILE
          echo " backend_build_successful=true" >> $BUILDEVENT_FILE

      - name: End build event
        id: end-build
        run: |
          STEP_ID=$(echo "${{ steps.build-backend-image.outputs.STEP_ID }}")
          STEP_START=$(echo "${{ steps.build-backend-image.outputs.STEP_START }}")
          PARENT_ID=$(echo "${{ steps.build-backend-image.outputs.TRACE_PARENT }}")
          buildevents child $TRACE_ID $PARENT_ID $STEP_ID $STEP_START "Build Backend Image"

  build-frontend:
    runs-on: ubuntu-latest
    needs: [start-build-and-test-span]
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.get_short_sha.outputs.short_sha }}

    steps:
      - uses: honeycombio/gha-buildevents@v2
        with:
          apikey: ${{ secrets.HONEYCOMB_API_KEY }}
          dataset: syllabus-tracker-build-events

      - name: Set build start timestamp
        id: build-frontend-image
        run: |
          echo "STEP_START=$(date +%s)" >> $GITHUB_OUTPUT
          echo "STEP_ID=build-frontend-image" >> $GITHUB_OUTPUT
          echo "TRACE_PARENT=${{ needs.start-build-and-test-span.outputs.build_span_id }}" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get short SHA
        id: get_short_sha
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push frontend Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ steps.get_short_sha.outputs.short_sha }},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_HONEYCOMB_API_KEY=${{ secrets.HONEYCOMB_API_KEY }}
            VITE_API_URL=/api
            VITE_ENVIRONMENT=production

      - name: Log build details to telemetry
        run: |
          echo " frontend_image_tag=frontend:${{ steps.get_short_sha.outputs.short_sha }}" >> $BUILDEVENT_FILE
          echo " frontend_build_successful=true" >> $BUILDEVENT_FILE

      - name: End build event
        id: end-build
        run: |
          STEP_ID=$(echo "${{ steps.build-frontend-image.outputs.STEP_ID }}")
          STEP_START=$(echo "${{ steps.build-frontend-image.outputs.STEP_START }}")
          PARENT_ID=$(echo "${{ steps.build-frontend-image.outputs.TRACE_PARENT }}")
          buildevents child $TRACE_ID $PARENT_ID $STEP_ID $STEP_START "Build Frontend Image"

  close-build-span:
    needs: [start-build-and-test-span, build-backend, build-frontend, test]
    runs-on: ubuntu-latest
    steps:
      - uses: honeycombio/gha-buildevents@v2
        with:
          apikey: ${{ secrets.HONEYCOMB_API_KEY }}
          dataset: syllabus-tracker-build-events
          trace_id: ${{ needs.start-build-and-test-span.outputs.trace_id }}

      - name: Close build parent span
        run: |
          TRACE_ID=${{ needs.start-build-and-test-span.outputs.trace_id }}
          SPAN_ID=${{ needs.start-build-and-test-span.outputs.build_span_id }}
          START_TIME=${{ needs.start-build-and-test-span.outputs.build_span_start }}

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          # Add any metadata to the parent span
          echo "backend_image=app:${{ needs.build-backend.outputs.image_tag }}" >> $BUILDEVENT_FILE
          echo "frontend_image=frontend:${{ needs.build-frontend.outputs.image_tag }}" >> $BUILDEVENT_FILE
          echo "build_duration_seconds=$DURATION" >> $BUILDEVENT_FILE
          echo "all_steps_passed=true" >> $BUILDEVENT_FILE

          # Close the parent span
          buildevents span $TRACE_ID $SPAN_ID $START_TIME "Build and Test"

  deploy:
    needs: [build-backend, build-frontend, test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Get workflow conclusion
        uses: technote-space/workflow-conclusion-action@v3

      - uses: honeycombio/gha-buildevents@v2
        with:
          apikey: ${{ secrets.HONEYCOMB_API_KEY }}
          dataset: syllabus-tracker-build-events
          status: ${{ env.WORKFLOW_CONCLUSION }}

      - name: Checkout code (minimal for config files)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            docker-compose.prod.yml
            config/
            nginx/
            scripts/

      - name: Set up SSH
        run: |
          STEP_ID=set_up_ssh
          STEP_START=$(date +%s)
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          buildevents step $TRACE_ID $STEP_ID $STEP_START $STEP_ID

      - name: Transfer essential files to server
        run: |
          STEP_ID=transfer_files
          STEP_START=$(date +%s)

          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "mkdir -p ~/syllabus-tracker/config ~/syllabus-tracker/scripts ~/syllabus-tracker/nginx"

          # Only transfer essential files
          rsync -avzi --include="docker-compose.prod.yml" \
            --include="config/***" \
            --include="scripts/***" \
            --include="nginx/***" \
            --exclude="*" \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:~/syllabus-tracker/

          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "chmod +x ~/syllabus-tracker/scripts/*.sh"

          buildevents step $TRACE_ID $STEP_ID $STEP_START $STEP_ID

      - name: Generate secrets file
        run: |
          STEP_ID=generate_secrets
          STEP_START=$(date +%s)

          echo "HONEYCOMB_API_KEY=${{ secrets.HONEYCOMB_API_KEY }}" > .secrets.env
          echo "ROCKET_SECRET_KEY=${{ secrets.ROCKET_SECRET_KEY }}" >> .secrets.env
          echo "VITE_HONEYCOMB_API_KEY=${{ secrets.HONEYCOMB_API_KEY }}" >> .secrets.env

          scp .secrets.env ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:~/syllabus-tracker/

          buildevents step $TRACE_ID $STEP_ID $STEP_START $STEP_ID

      - name: Set up GitHub Container Registry credentials on server
        run: |
          STEP_ID=setup_registry_creds
          STEP_START=$(date +%s)

          # Create a JSON config for Docker to authenticate with GHCR
          cat > docker_config.json << EOF
          {
            "auths": {
              "${{ env.REGISTRY }}": {
                "auth": "$(echo -n ${{ github.actor }}:${{ secrets.GITHUB_TOKEN }} | base64)"
              }
            }
          }
          EOF

          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "mkdir -p ~/.docker"
          scp docker_config.json ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:~/.docker/config.json

          buildevents step $TRACE_ID $STEP_ID $STEP_START $STEP_ID

      - name: Deploy with Docker Compose
        run: |
          STEP_ID=deploy_docker
          STEP_START=$(date +%s)

          APP_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/app:${{ needs.build.outputs.image_tag }}"
          FRONTEND_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ needs.build.outputs.image_tag }}"
          GITHUB_REPOSITORY="${{ github.repository }}"

          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "cd ~/syllabus-tracker && \
            export APP_IMAGE=${APP_IMAGE} && \
            export FRONTEND_IMAGE=${FRONTEND_IMAGE} && \
            export GITHUB_REPOSITORY=${GITHUB_REPOSITORY} && \
            docker compose -f docker-compose.prod.yml pull && \
            docker compose -f docker-compose.prod.yml up -d"

          echo "Monitoring deployment for 30 seconds..."
          sleep 30

          CONTAINER_STATUS=$(ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "docker ps --filter name=syllabus-tracker-app --format '{{.Status}}' | grep -o '(healthy)\\|(unhealthy)' || echo 'not found'")

          if [[ "$CONTAINER_STATUS" != *"healthy"* ]]; then
            echo "Warning: Container is not healthy. Deployment may have failed."
            echo " deployment_status=unhealthy" >> $BUILDEVENT_FILE
            echo " deploy_completed=false" >> $BUILDEVENT_FILE
            buildevents step $TRACE_ID $STEP_ID $STEP_START $STEP_ID
            exit 1
          fi

          # Clean up old images
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "docker image prune -f"

          echo " deployed_app_image=${APP_IMAGE}" >> $BUILDEVENT_FILE
          echo " deployed_frontend_image=${FRONTEND_IMAGE}" >> $BUILDEVENT_FILE
          buildevents step $TRACE_ID $STEP_ID $STEP_START $STEP_ID

      - name: Create Honeycomb deployment marker
        run: |
          STEP_ID=create_marker
          STEP_START=$(date +%s)

          DEPLOY_TIME=$(date +%s)
          GIT_COMMIT_HASH=$(git rev-parse HEAD)
          GIT_COMMIT_MESSAGE=$(git log -1 --pretty=%B | tr -d '\n')

          curl -X POST "https://api.honeycomb.io/1/markers/__all__" \
            -H "X-Honeycomb-Team: ${{ secrets.HONEYCOMB_MARKER_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"message\": \"Deployed commit ${GIT_COMMIT_HASH}\",
              \"type\": \"deploy\",
              \"start_time\": ${DEPLOY_TIME},
              \"url\": \"https://github.com/${{ github.repository }}/commit/${{ github.sha }}\",
              \"metadata\": {
                \"commit_hash\": \"${GIT_COMMIT_HASH}\",
                \"commit_message\": \"${GIT_COMMIT_MESSAGE}\",
                \"github_actor\": \"${{ github.actor }}\",
                \"github_repository\": \"${{ github.repository }}\",
                \"github_ref\": \"${{ github.ref }}\"
              }
            }"

          buildevents step $TRACE_ID $STEP_ID $STEP_START $STEP_ID
        env:
          HONEYCOMB_API_KEY: ${{ secrets.HONEYCOMB_API_KEY }}
